<div class="qsys-browser">
  <!-- Global Control Search (moved up since header is now at app level) -->
  <div class="global-search-container">
    <button class="back-button" (click)="navigateToMenu()" title="Back to Menu">
      ‚Üê
    </button>
    <input
      type="text"
      class="global-search-input"
      placeholder="üîç Search all controls (supports regex)..."
      [(ngModel)]="globalSearchTerm"
      (input)="onGlobalSearchChange()"
      [disabled]="!isConnected()"
    />
    @if (globalSearchTerm) {
      <button class="clear-search-button" (click)="clearGlobalSearch()">‚úï</button>
    }
  </div>

  <!-- Loading Notifications with Stage Details -->
  @if (loadingStage()) {
    <div class="loading-notification-detailed">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <div class="loading-text">
          <div class="loading-stage">{{ loadingStage() }}</div>
          @if (loadingSubStage()) {
            <div class="loading-substage">{{ loadingSubStage() }}</div>
          }
        </div>
      </div>
    </div>
  }

  <!-- Certificate Error Notification -->
  @if (showCertificateErrorNotification()) {
    <div class="certificate-error-notification">
      <div class="notification-content">
        <div class="notification-icon">‚ö†Ô∏è</div>
        <div class="notification-message">
          <strong>SSL Certificate Error</strong>
          <p>Unable to connect to Q-SYS Core. Please accept the security certificate.</p>
          <div class="notification-actions">
            <button class="accept-cert-button" (click)="openCertificateUrl()">
              Open {{ coreIp }} & Accept Certificate
            </button>
            <button class="dismiss-button" (click)="dismissCertificateError()">Dismiss</button>
          </div>
        </div>
        <button class="close-notification" (click)="dismissCertificateError()">‚úï</button>
      </div>
    </div>
  }

  <!-- WebSocket Error Notification -->
  @if (showWebSocketErrorNotification()) {
    <div class="certificate-error-notification websocket-error">
      <div class="notification-content">
        <div class="notification-icon">‚ö†Ô∏è</div>
        <div class="notification-message">
          <strong>"Script only" WebSocket Server Not Available</strong>
          <p>{{ webSocketErrorMessage() }}</p>
          <p class="help-text">To use "Script only" WebSocket discovery:</p>
          <ol class="help-steps">
            <li>Select a Script component in the Q-SYS Component Browser</li>
            <li>Navigate to the 'code' control in the editor</li>
            <li>Use the Lua Script Management section to insert the "WebSocket Component Discovery" script</li>
            <li>Click the "Update" or "Insert" button to load the script</li>
            <li>Try 'Discover "Script only"'' again</li>
          </ol>
          <div class="notification-actions">
            <button class="dismiss-button" (click)="dismissWebSocketError()">Dismiss</button>
          </div>
        </div>
        <button class="close-notification" (click)="dismissWebSocketError()">‚úï</button>
      </div>
    </div>
  }

  <!-- Global Search Results View -->
  @if (isGlobalSearchActive) {
    <div class="view">
      <div class="view-header">
        <h2>Search Results ({{ filteredGlobalSearchResults.length }} controls)</h2>
        <button class="back-button" (click)="clearGlobalSearch()">‚Üê Clear Search</button>
        <select
          class="type-filter"
          [(ngModel)]="globalSearchTypeFilter"
        >
          @for (type of globalSearchAvailableTypes; track type) {
            <option [value]="type">{{ type === 'all' ? 'All Types' : type }}</option>
          }
        </select>
      </div>

      <div class="control-list">
        @for (control of filteredGlobalSearchResults; track control.name + control.componentName) {
          <div class="control-item" (click)="selectControlFromGlobalSearch(control)">
            <div class="control-header">
              <div class="control-name">
                {{ control.name }}
                <span class="component-badge">{{ control.componentName }}</span>
              </div>
              <div class="control-meta">
                <span class="control-type">{{ control.type }}</span>
                <span class="control-direction">{{ control.direction }}</span>
              </div>
            </div>

            <div class="control-editor-inline" (click)="$event.stopPropagation()">
              @switch (control.type) {
                @case ('Boolean') {
                  <app-boolean-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="handleControlValueChange(control, $event)"
                  />
                }
                @case ('Knob') {
                  <app-knob-control
                    [control]="control"
                    [mode]="'inline'"
                    (positionChange)="handleControlPositionChange(control, $event)"
                    (dragStart)="onInlineSliderDragStart(control)"
                    (dragEnd)="onInlineSliderDragEnd()"
                  />
                }
                @case ('Float') {
                  <app-numeric-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="handleControlValueChange(control, $event)"
                  />
                }
                @case ('Integer') {
                  <app-numeric-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="handleControlValueChange(control, $event)"
                  />
                }
                @case ('Combo box') {
                  <app-combo-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="handleControlValueChange(control, $event)"
                  />
                }
                @case ('Text') {
                  <app-text-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="handleControlValueChange(control, $event)"
                  />
                }
                @case ('Status') {
                  <app-status-control
                    [control]="control"
                    [mode]="'inline'"
                  />
                }
                @case ('State Trigger') {
                  <app-state-trigger-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="handleControlValueChange(control, $event)"
                  />
                }
                @case ('Time') {
                  <app-time-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="handleControlValueChange(control, $event)"
                  />
                }
                @case ('Trigger') {
                  <app-trigger-control
                    [control]="control"
                    (trigger)="handleControlTrigger(control)"
                  />
                }
              }
            </div>
          </div>
        }
        @if (filteredGlobalSearchResults.length === 0 && !isLoadingComponents) {
          <div class="no-results">No controls found matching "{{ globalSearchTerm }}"</div>
        }
      </div>
    </div>
  }

  <!-- Component List View -->
  @if (currentView === 'components' && !isGlobalSearchActive) {
    <div class="view">
      <div class="view-header">
        <h2>Components ({{ filteredComponents.length }})</h2>
        <!-- Hidden: Refresh and Discover buttons - components are now cached and auto-discovered -->
        <select
          class="type-filter"
          [(ngModel)]="selectedTypeFilter"
        >
          @for (type of availableTypes; track type) {
            <option [value]="type">
              {{ type === 'all' ? 'All Types' : type === 'plugins' ? 'Plugins' : formatComponentType(type) }}
            </option>
          }
        </select>
        <input
          type="text"
          class="search-input"
          placeholder="Search components (supports regex)..."
          [(ngModel)]="searchTerm"
        />
      </div>

      <div class="component-list">
        @for (component of filteredComponents; track component.name) {
          <div class="component-item" (click)="selectComponent(component)" [class.websocket-discovered]="component.discoveryMethod === 'websocket'">
            <div class="component-header">
              <div class="component-name">
                {{ component.name }}
                @if (component.discoveryMethod === 'websocket') {
                  <span class="discovery-badge" title="Discovered via WebSocket (HTTP API mode)">üîå Sript only</span>
                }
              </div>
              <div class="component-meta">
                <span class="component-type">{{ formatComponentType(component.type) }}</span>
                @if (component.controlCount === -1) {
                  <span class="component-info script-only" title="Controls not loaded by QRWC, will fetch via HTTP API">üì° HTTP API</span>
                } @else {
                  <span class="component-info">{{ component.controlCount }} controls</span>
                }
              </div>
            </div>
          </div>
        }
      </div>
    </div>
  }

  <!-- Control List View -->
  @if (currentView === 'controls') {
    <div class="view">
      <div class="view-header">
        <button class="back-button" (click)="backToComponents()">‚Üê Back</button>
        <h2>{{ browserService.selectedComponent()?.name }}</h2>
        <select
          class="type-filter"
          [(ngModel)]="selectedControlTypeFilter"
        >
          @for (type of availableControlTypes; track type) {
            <option [value]="type">{{ type === 'all' ? 'All Types' : type }}</option>
          }
        </select>
        <input
          type="text"
          class="search-input"
          placeholder="Search controls (supprts regex)..."
          [(ngModel)]="controlSearchTerm"
        />
      </div>

      <div class="control-list">
        @for (control of filteredControls; track control.name) {
          <div class="control-item" (click)="onControlClick(control, $event)">
            <div class="control-header">
              <div class="control-name">{{ control.name }}</div>
              <div class="control-meta">
                <span class="control-type">{{ control.type }}</span>
                <span class="control-direction">{{ control.direction }}</span>
              </div>
            </div>

            <div class="control-editor-inline" (click)="$event.stopPropagation()">
              @switch (control.type) {
                @case ('Boolean') {
                  <app-boolean-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="handleControlValueChange(control, $event)"
                  />
                }
                @case ('Knob') {
                  <app-knob-control
                    [control]="control"
                    [mode]="'inline'"
                    (positionChange)="handleControlPositionChange(control, $event)"
                    (dragStart)="onInlineSliderDragStart(control)"
                    (dragEnd)="onInlineSliderDragEnd()"
                  />
                }
                @case ('Float') {
                  <app-numeric-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="handleControlValueChange(control, $event)"
                  />
                }
                @case ('Integer') {
                  <app-numeric-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="handleControlValueChange(control, $event)"
                  />
                }
                @case ('Combo box') {
                  <app-combo-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="handleControlValueChange(control, $event)"
                  />
                }
                @case ('Text') {
                  <app-text-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="handleControlValueChange(control, $event)"
                  />
                }
                @case ('Status') {
                  <app-status-control
                    [control]="control"
                    [mode]="'inline'"
                  />
                }
                @case ('State Trigger') {
                  <app-state-trigger-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="handleControlValueChange(control, $event)"
                  />
                }
                @case ('Time') {
                  <app-time-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="handleControlValueChange(control, $event)"
                  />
                }
                @case ('Trigger') {
                  <app-trigger-control
                    [control]="control"
                    (trigger)="handleControlTrigger(control)"
                  />
                }
              }
            </div>
          </div>
        }
      </div>
    </div>
  }

  <!-- Control Editor View -->
  @if (currentView === 'editor') {
    <div class="view">
      <div class="view-header">
        <button class="back-button" (click)="backToControls()">‚Üê Back</button>
        <div class="header-text">
          <div class="component-name-header">{{ browserService.selectedComponent()?.name }}</div>
          <h2>{{ browserService.selectedControl()?.name }}</h2>
        </div>
      </div>

      @if (browserService.selectedControl(); as control) {
        <div class="control-editor">
          @if (!isCodeControl()) {
            <div class="editor-section">
              <label>Type</label>
              <div class="info-value">{{ control.type }}</div>
            </div>
          }

          <!-- Boolean Control -->
          @if (control.type === 'Boolean') {
            <div class="editor-section">
              <app-boolean-control
                [control]="control"
                mode="editor"
                (valueChange)="handleControlValueChange(control, $event)"
              ></app-boolean-control>
            </div>
          }

          <!-- Knob/Level Control -->
          @if (control.type === 'Knob') {
            <div class="editor-section">
              <app-knob-control
                [control]="control"
                mode="editor"
                (positionChange)="handleControlPositionChange(control, $event)"
                (dragStart)="onInlineSliderDragStart(control)"
                (dragEnd)="onInlineSliderDragEnd()"
              ></app-knob-control>
            </div>
          }

          <!-- Numeric Control (Float/Integer) -->
          @if (control.type === 'Float' || control.type === 'Integer') {
            <div class="editor-section">
              <app-numeric-control
                [control]="control"
                mode="editor"
                (valueChange)="handleControlValueChange(control, $event)"
              ></app-numeric-control>
            </div>
          }

          <!-- Combo box Control -->
          @if (control.type === 'Combo box' && control.choices) {
            <div class="editor-section">
              <app-combo-control
                [control]="control"
                mode="editor"
                (valueChange)="handleControlValueChange(control, $event)"
              ></app-combo-control>
            </div>
          }

          <!-- Text Control -->
          @if (control.type === 'Text') {
            <div class="editor-section">
              <app-text-control
                [control]="control"
                mode="editor"
                (valueChange)="onTextControlValueChange($event)"
              ></app-text-control>
            </div>

            <!-- Lua Script Management (only for 'code' controls) -->
            @if (isCodeControl() && control.direction !== 'Read Only') {
              <div class="editor-section">
                <label>Lua Script Management</label>
                <div class="lua-script-manager">
                  @for (script of getAvailableLuaScripts(); track script.fileName) {
                    <div class="lua-script-item">
                      <div class="lua-script-info">
                        <span class="lua-script-name">{{ script.name }}</span>
                        <span class="lua-script-filename">{{ script.fileName }}</span>
                        @if (isScriptPresent(script.name)) {
                          <span class="lua-script-status present">‚úì Present</span>
                        } @else {
                          <span class="lua-script-status absent">Not present</span>
                        }
                      </div>
                      <div class="lua-script-actions">
                        @if (isScriptPresent(script.name)) {
                          <button class="lua-action-button update" (click)="insertLuaScript(script)">
                            Update
                          </button>
                          <button class="lua-action-button remove" (click)="removeLuaScript(script.name)">
                            Remove
                          </button>
                        } @else {
                          <button class="lua-action-button insert" (click)="insertLuaScript(script)">
                            Insert
                          </button>
                        }
                      </div>
                    </div>
                  }
                </div>
              </div>

              <!-- Log History Viewer -->
              <div class="editor-section">
                <div class="log-history-header">
                  <label>Log History</label>

                  <div class="script-controls-inline">
                    <!-- script.status control -->
                    <div class="script-control-inline">
                      <span class="script-control-label-inline">Status:</span>
                      <span class="script-control-value-inline status" [ngClass]="getScriptStatusClass()">
                        {{ getScriptControlValue('script.status') || 'N/A' }}
                      </span>
                    </div>

                    <!-- script.memory control -->
                    <div class="script-control-inline">
                      <span class="script-control-label-inline">Memory:</span>
                      <span class="script-control-value-inline">
                        {{ getScriptControlValue('script.memory') || 'N/A' }}
                      </span>
                    </div>

                    <!-- log.clear control -->
                    <button class="script-control-button-inline" (click)="triggerScriptControl('log.clear')">
                      Clear Log
                    </button>

                    <!-- Import discovered components button -->
                    <button class="script-control-button-inline import" (click)="parseDiscoveryResults()" [disabled]="getLogHistory().length === 0">
                      Import Components
                    </button>
                  </div>

                  <button class="clear-log-button" (click)="clearLogHistory()" [disabled]="getLogHistory().length === 0">
                    Clear
                  </button>
                </div>
                <div class="log-history-viewer">
                  @if (getLogHistory().length === 0) {
                    <div class="log-empty">No log entries yet. Logs from 'log.history' control will appear here.</div>
                  } @else {
                    <div class="log-entries">
                      @for (entry of getLogHistory(); track $index) {
                        <div class="log-entry">{{ entry }}</div>
                      }
                    </div>
                  }
                </div>
              </div>
            }
          }

          <!-- Trigger Control -->
          @if (control.type === 'Trigger') {
            <div class="editor-section">
              <app-trigger-control
                [control]="control"
                mode="editor"
                (trigger)="handleControlTrigger(control)"
              ></app-trigger-control>
            </div>
          }

          <!-- State Trigger Control -->
          @if (control.type === 'State Trigger') {
            <div class="editor-section">
              <app-state-trigger-control
                [control]="control"
                mode="editor"
                (valueChange)="handleControlValueChange(control, $event)"
                (trigger)="handleControlTrigger(control)"
              ></app-state-trigger-control>
            </div>
          }

          <!-- Status Control -->
          @if (control.type === 'Status') {
            <div class="editor-section">
              <app-status-control
                [control]="control"
                mode="editor"
                (valueChange)="handleControlValueChange(control, $event)"
              ></app-status-control>
            </div>
          }

          <!-- Time Control -->
          @if (control.type === 'Time') {
            <div class="editor-section">
              <app-time-control
                [control]="control"
                mode="editor"
                (valueChange)="handleControlValueChange(control, $event)"
              ></app-time-control>
            </div>
          }

          @if (control.direction === 'Read Only') {
            <div class="editor-section">
              <div class="read-only-notice">This control is read-only</div>
            </div>
          }
        </div>
      }
    </div>
  }
</div>
