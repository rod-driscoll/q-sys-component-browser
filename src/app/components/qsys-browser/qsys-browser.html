<div class="qsys-browser">
  <!-- Header -->
  <div class="header">
    <h1>Q-SYS Component Browser</h1>
    <div class="connection-status" [class.connected]="isConnected()">
      {{ isConnected() ? 'Connected' : 'Disconnected' }}
    </div>
  </div>

  <!-- Loading Notifications -->
  @if (isLoadingComponents) {
    <div class="loading-notification">
      <div class="loading-spinner"></div>
      <span>Loading components...</span>
    </div>
  }
  @if (isLoadingControls) {
    <div class="loading-notification">
      <div class="loading-spinner"></div>
      <span>Loading controls...</span>
    </div>
  }

  <!-- Component List View -->
  @if (currentView === 'components') {
    <div class="view">
      <div class="view-header">
        <h2>Components ({{ filteredComponents.length }})</h2>
        <button class="refresh-button" (click)="loadComponents()" [disabled]="!isConnected()">
          üîÑ Refresh
        </button>
        <select
          class="type-filter"
          [(ngModel)]="selectedTypeFilter"
        >
          @for (type of availableTypes; track type) {
            <option [value]="type">{{ type === 'all' ? 'All Types' : type }}</option>
          }
        </select>
        <input
          type="text"
          class="search-input"
          placeholder="Search components..."
          [(ngModel)]="searchTerm"
        />
      </div>

      <div class="component-list">
        @for (component of filteredComponents; track component.name) {
          <div class="component-item" (click)="selectComponent(component)">
            <div class="component-name">{{ component.name }}</div>
            <div class="component-meta">
              <span class="component-type">{{ component.type }}</span>
              <span class="component-info">{{ component.controlCount }} controls</span>
            </div>
          </div>
        }
      </div>
    </div>
  }

  <!-- Control List View -->
  @if (currentView === 'controls') {
    <div class="view">
      <div class="view-header">
        <button class="back-button" (click)="backToComponents()">‚Üê Back</button>
        <h2>{{ browserService.selectedComponent()?.name }}</h2>
        <select
          class="type-filter"
          [(ngModel)]="selectedControlTypeFilter"
        >
          @for (type of availableControlTypes; track type) {
            <option [value]="type">{{ type === 'all' ? 'All Types' : type }}</option>
          }
        </select>
        <input
          type="text"
          class="search-input"
          placeholder="Search controls..."
          [(ngModel)]="controlSearchTerm"
        />
      </div>

      <div class="control-list">
        @for (control of filteredControls; track control.name) {
          <div class="control-item" (click)="selectControl(control)">
            <div class="control-name">{{ control.name }}</div>
            <div class="control-meta">
              <span class="control-type">{{ control.type }}</span>
              <span class="control-direction">{{ control.direction }}</span>
            </div>
            @if (control.value !== undefined || control.string) {
              @if (control.type === 'Text') {
                <div class="control-value-text">{{ control.string || control.value }}</div>
              } @else if (control.type === 'Status') {
                <div class="control-value-status" [ngClass]="getStatusColorClassForControl(control)">
                  {{ control.string || control.value }}
                </div>
              } @else {
                <div class="control-value">{{ control.string || control.value }}</div>
              }
            }
          </div>
        }
      </div>
    </div>
  }

  <!-- Control Editor View -->
  @if (currentView === 'editor') {
    <div class="view">
      <div class="view-header">
        <button class="back-button" (click)="backToControls()">‚Üê Back</button>
        <div class="header-text">
          <div class="component-name-header">{{ browserService.selectedComponent()?.name }}</div>
          <h2>{{ browserService.selectedControl()?.name }}</h2>
        </div>
      </div>

      @if (browserService.selectedControl(); as control) {
        <div class="control-editor">
          <div class="editor-section">
            <label>Type</label>
            <div class="info-value">{{ control.type }}</div>
          </div>

          <!-- Boolean Control -->
          @if (control.type === 'Boolean') {
            <div class="editor-section">
              <label>Value</label>
              <div class="toggle-group">
                <button
                  class="toggle-button"
                  [class.active]="!editValue"
                  (click)="setBooleanValue(false)"
                  [disabled]="control.direction === 'Read Only'"
                >
                  Off (0)
                </button>
                <button
                  class="toggle-button"
                  [class.active]="editValue"
                  (click)="setBooleanValue(true)"
                  [disabled]="control.direction === 'Read Only'"
                >
                  On (1)
                </button>
              </div>
            </div>
          }

          <!-- Knob/Level Control -->
          @if (control.type === 'Knob') {
            <div class="editor-section">
              @if (control.direction === 'Read Only') {
                <label>Value</label>
                <div class="info-value">{{ getDisplayValue() }}</div>
              } @else {
                <label>Level ({{ getDisplayValue() }})</label>
                <input
                  type="range"
                  class="slider"
                  [(ngModel)]="editValue"
                  (input)="onSliderInput($event)"
                  (mousedown)="onSliderDragStart()"
                  (mouseup)="onSliderDragEnd()"
                  (touchstart)="onSliderDragStart()"
                  (touchend)="onSliderDragEnd()"
                  [min]="getSliderMin()"
                  [max]="getSliderMax()"
                  step="0.1"
                />
              }
            </div>
          }

          <!-- Numeric Control (Float/Integer) -->
          @if (control.type === 'Float' || control.type === 'Integer') {
            <div class="editor-section">
              <label>Value</label>
              @if (control.direction === 'Read Only') {
                <div class="info-value">{{ editValue }}</div>
              } @else {
                <input
                  type="number"
                  class="value-input"
                  [(ngModel)]="editValue"
                  (ngModelChange)="updateControl()"
                  [step]="control.type === 'Integer' ? 1 : 0.1"
                />
              }
            </div>
          }

          <!-- Combo box Control -->
          @if (control.type === 'Combo box' && control.choices) {
            <div class="editor-section">
              <label>Value</label>
              @if (control.direction === 'Read Only') {
                <div class="info-value">{{ editValue }}</div>
              } @else {
                <select
                  class="value-input"
                  [(ngModel)]="editValue"
                  (ngModelChange)="updateControl()"
                >
                  @for (choice of control.choices; track choice) {
                    <option [value]="choice">{{ choice }}</option>
                  }
                </select>
              }
            </div>
          }

          <!-- Text Control -->
          @if (control.type === 'Text') {
            <div class="editor-section">
              <label>Value</label>
              @if (control.direction === 'Read Only' || control.direction === 'Write Only') {
                <div class="text-display">{{ editValue }}</div>
              } @else {
                <textarea
                  class="text-area-input"
                  [(ngModel)]="editValue"
                  (ngModelChange)="updateControl()"
                  rows="4"
                ></textarea>
              }
            </div>
          }

          <!-- Trigger Control -->
          @if (control.type === 'Trigger') {
            <div class="editor-section">
              <label>Trigger Action</label>
              <button
                class="trigger-button"
                (click)="triggerControl()"
                [disabled]="control.direction === 'Read Only'"
              >
                Trigger
              </button>
            </div>
          }

          <!-- State Trigger Control -->
          @if (control.type === 'State Trigger') {
            @if (control.direction === 'Read Only') {
              <div class="editor-section">
                <label>Value</label>
                <div class="info-value">{{ editValue }}</div>
              </div>
            } @else {
              <div class="editor-section">
                <label>State Value</label>
                <select
                  class="value-input"
                  [(ngModel)]="editValue"
                  (ngModelChange)="updateControl()"
                >
                  @for (value of getStateTriggerValues(); track value) {
                    <option [value]="value">{{ value }}</option>
                  }
                </select>
              </div>
              <div class="editor-section">
                <label>Trigger Action</label>
                <button
                  class="trigger-button"
                  (click)="triggerControl()"
                >
                  Trigger
                </button>
              </div>
            }
          }

          <!-- Status Control -->
          @if (control.type === 'Status') {
            <div class="editor-section">
              <label>Status</label>
              @if (control.direction === 'Read Only') {
                <div class="status-display" [ngClass]="getStatusColorClass()">
                  <div class="status-value">{{ control.string || control.value || 'N/A' }}</div>
                  @if (control.value !== undefined && control.valueMin !== undefined && control.valueMax !== undefined) {
                    <div class="status-range">
                      Range: {{ control.valueMin }} - {{ control.valueMax }}
                    </div>
                  }
                </div>
              } @else {
                <select
                  class="status-select"
                  [(ngModel)]="editValue"
                  (ngModelChange)="updateControl()"
                  [ngClass]="getStatusColorClass()"
                >
                  <option [value]="0">0 - OK</option>
                  <option [value]="1">1 - Compromised</option>
                  <option [value]="2">2 - Fault</option>
                  <option [value]="3">3 - Not Present</option>
                  <option [value]="4">4 - Missing</option>
                  <option [value]="5">5 - Initializing</option>
                </select>
                @if (control.string) {
                  <div class="status-info">{{ control.string }}</div>
                }
              }
            </div>
          }

          <!-- Time Control -->
          @if (control.type === 'Time') {
            <div class="editor-section">
              <label>Time Value</label>
              @if (control.direction === 'Read Only') {
                <div class="time-display">
                  <div class="time-value">{{ control.string || control.value || 'N/A' }}</div>
                  @if (control.value !== undefined) {
                    <div class="time-info">Raw Value: {{ control.value }}</div>
                  }
                </div>
              } @else {
                <div class="time-input-group">
                  <input
                    type="text"
                    class="time-segment"
                    [(ngModel)]="timeHours"
                    (ngModelChange)="onTimeChange()"
                    (focus)="onTimeSegmentFocus($event)"
                    placeholder="00"
                    maxlength="2"
                    pattern="[0-9]{0,2}"
                  />
                  <span class="time-separator">:</span>
                  <input
                    type="text"
                    class="time-segment"
                    [(ngModel)]="timeMinutes"
                    (ngModelChange)="onTimeChange()"
                    (focus)="onTimeSegmentFocus($event)"
                    placeholder="00"
                    maxlength="2"
                    pattern="[0-9]{0,2}"
                  />
                  <span class="time-separator">:</span>
                  <input
                    type="text"
                    class="time-segment"
                    [(ngModel)]="timeSeconds"
                    (ngModelChange)="onTimeChange()"
                    (focus)="onTimeSegmentFocus($event)"
                    placeholder="00"
                    maxlength="2"
                    pattern="[0-9]{0,2}"
                  />
                </div>
              }
            </div>
          }

          @if (control.direction === 'Read Only') {
            <div class="editor-section">
              <div class="read-only-notice">This control is read-only</div>
            </div>
          }
        </div>
      }
    </div>
  }
</div>
