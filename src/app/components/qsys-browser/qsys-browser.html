<div class="qsys-browser">
  <!-- Header -->
  <div class="header">
    <div class="header-main">
      <div class="header-left">
        <h1>Q-SYS Component Browser</h1>
        <div class="project-detail-item">
          <span class="detail-label">Project:</span>
          <span class="detail-value">{{ designName || 'Loading...' }}</span>
        </div>
      </div>
      <div class="header-right">
        <div class="connection-status" [class.connected]="isConnected()">
          {{ isConnected() ? 'Connected' : 'Disconnected' }}
        </div>
        <div class="core-ip">{{ coreIp }}</div>
        @if (corePlatform && coreState) {
          <div class="core-info">{{ corePlatform }} ({{ coreState }})</div>
        }
      </div>
    </div>

    <!-- Global Control Search -->
    <div class="global-search-container">
      <input
        type="text"
        class="global-search-input"
        placeholder="üîç Search all controls (supports regex)..."
        [(ngModel)]="globalSearchTerm"
        (input)="onGlobalSearchChange()"
        [disabled]="!isConnected()"
      />
      @if (globalSearchTerm) {
        <button class="clear-search-button" (click)="clearGlobalSearch()">‚úï</button>
      }
    </div>
  </div>

  <!-- Loading Notifications -->
  @if (isLoadingComponents) {
    <div class="loading-notification">
      <div class="loading-spinner"></div>
      <span>Loading components...</span>
    </div>
  }
  @if (isLoadingControls) {
    <div class="loading-notification">
      <div class="loading-spinner"></div>
      <span>Loading controls...</span>
    </div>
  }

  <!-- Certificate Error Notification -->
  @if (showCertificateErrorNotification()) {
    <div class="certificate-error-notification">
      <div class="notification-content">
        <div class="notification-icon">‚ö†Ô∏è</div>
        <div class="notification-message">
          <strong>SSL Certificate Error</strong>
          <p>Unable to connect to Q-SYS Core. Please accept the security certificate.</p>
          <div class="notification-actions">
            <button class="accept-cert-button" (click)="openCertificateUrl()">
              Open {{ coreIp }} & Accept Certificate
            </button>
            <button class="dismiss-button" (click)="dismissCertificateError()">Dismiss</button>
          </div>
        </div>
        <button class="close-notification" (click)="dismissCertificateError()">‚úï</button>
      </div>
    </div>
  }

  <!-- Global Search Results View -->
  @if (isGlobalSearchActive) {
    <div class="view">
      <div class="view-header">
        <h2>Search Results ({{ filteredGlobalSearchResults.length }} controls)</h2>
        <button class="back-button" (click)="clearGlobalSearch()">‚Üê Clear Search</button>
        <select
          class="type-filter"
          [(ngModel)]="globalSearchTypeFilter"
        >
          @for (type of globalSearchAvailableTypes; track type) {
            <option [value]="type">{{ type === 'all' ? 'All Types' : type }}</option>
          }
        </select>
      </div>

      <div class="control-list">
        @for (control of filteredGlobalSearchResults; track control.name + control.componentName) {
          <div class="control-item" (click)="selectControlFromGlobalSearch(control)">
            <div class="control-header">
              <div class="control-name">
                {{ control.name }}
                <span class="component-badge">{{ control.componentName }}</span>
              </div>
              <div class="control-meta">
                <span class="control-type">{{ control.type }}</span>
                <span class="control-direction">{{ control.direction }}</span>
              </div>
            </div>

            <div class="control-editor-inline" (click)="$event.stopPropagation()">
              @switch (control.type) {
                @case ('Boolean') {
                  <app-boolean-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="onGlobalSearchControlUpdate(control, $event)"
                  />
                }
                @case ('Knob') {
                  <app-knob-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="onGlobalSearchSliderInput(control, $event)"
                    (dragStart)="onInlineSliderDragStart(control)"
                    (dragEnd)="onInlineSliderDragEnd()"
                  />
                }
                @case ('Float') {
                  <app-numeric-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="onGlobalSearchValueChange(control, $event)"
                  />
                }
                @case ('Integer') {
                  <app-numeric-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="onGlobalSearchValueChange(control, $event)"
                  />
                }
                @case ('Combo box') {
                  <app-combo-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="onGlobalSearchComboChange(control, $event)"
                  />
                }
                @case ('Text') {
                  <app-text-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="onGlobalSearchTextChange(control, $event)"
                  />
                }
                @case ('Status') {
                  <app-status-control
                    [control]="control"
                    [mode]="'inline'"
                  />
                }
                @case ('State Trigger') {
                  <app-state-trigger-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="onGlobalSearchValueChange(control, $event)"
                  />
                }
                @case ('Time') {
                  <app-time-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="onGlobalSearchTimeChange(control, $event)"
                  />
                }
                @case ('Trigger') {
                  <app-trigger-control
                    [control]="control"
                    (trigger)="onGlobalSearchTrigger(control)"
                  />
                }
              }
            </div>
          </div>
        }
        @if (filteredGlobalSearchResults.length === 0 && !isLoadingComponents) {
          <div class="no-results">No controls found matching "{{ globalSearchTerm }}"</div>
        }
      </div>
    </div>
  }

  <!-- Component List View -->
  @if (currentView === 'components' && !isGlobalSearchActive) {
    <div class="view">
      <div class="view-header">
        <h2>Components ({{ filteredComponents.length }})</h2>
        <button class="refresh-button" (click)="refreshComponents()" [disabled]="!isConnected()" title="Refresh component control counts (waits 3s for lazy loading)">
          üîÑ Refresh
        </button>
        <button class="refresh-button" (click)="loadComponentsViaWebSocket()" title="Discover components via WebSocket (bypasses log system)">
          üîå WS Discovery
        </button>
        <select
          class="type-filter"
          [(ngModel)]="selectedTypeFilter"
        >
          @for (type of availableTypes; track type) {
            <option [value]="type">
              {{ type === 'all' ? 'All Types' : type === 'plugins' ? 'Plugins' : formatComponentType(type) }}
            </option>
          }
        </select>
        <input
          type="text"
          class="search-input"
          placeholder="Search components (supports regex)..."
          [(ngModel)]="searchTerm"
        />
      </div>

      <div class="component-list">
        @for (component of filteredComponents; track component.name) {
          <div class="component-item" (click)="selectComponent(component)" [class.websocket-discovered]="component.discoveryMethod === 'websocket'">
            <div class="component-header">
              <div class="component-name">
                {{ component.name }}
                @if (component.discoveryMethod === 'websocket') {
                  <span class="discovery-badge" title="Discovered via WebSocket (HTTP API mode)">üîå WS</span>
                }
              </div>
              <div class="component-meta">
                <span class="component-type">{{ formatComponentType(component.type) }}</span>
                <span class="component-info">{{ component.controlCount }} controls</span>
              </div>
            </div>
          </div>
        }
      </div>
    </div>
  }

  <!-- Control List View -->
  @if (currentView === 'controls') {
    <div class="view">
      <div class="view-header">
        <button class="back-button" (click)="backToComponents()">‚Üê Back</button>
        <h2>{{ browserService.selectedComponent()?.name }}</h2>
        <select
          class="type-filter"
          [(ngModel)]="selectedControlTypeFilter"
        >
          @for (type of availableControlTypes; track type) {
            <option [value]="type">{{ type === 'all' ? 'All Types' : type }}</option>
          }
        </select>
        <input
          type="text"
          class="search-input"
          placeholder="Search controls (supprts regex)..."
          [(ngModel)]="controlSearchTerm"
        />
      </div>

      <div class="control-list">
        @for (control of filteredControls; track control.name) {
          <div class="control-item" (click)="onControlClick(control, $event)">
            <div class="control-header">
              <div class="control-name">{{ control.name }}</div>
              <div class="control-meta">
                <span class="control-type">{{ control.type }}</span>
                <span class="control-direction">{{ control.direction }}</span>
              </div>
            </div>

            <div class="control-editor-inline" (click)="$event.stopPropagation()">
              @switch (control.type) {
                @case ('Boolean') {
                  <app-boolean-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="setControlValue(control, $event)"
                  />
                }
                @case ('Knob') {
                  <app-knob-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="onInlineSliderInput(control, $event)"
                    (dragStart)="onInlineSliderDragStart(control)"
                    (dragEnd)="onInlineSliderDragEnd()"
                  />
                }
                @case ('Float') {
                  <app-numeric-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="onInlineValueChange(control, $event)"
                  />
                }
                @case ('Integer') {
                  <app-numeric-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="onInlineValueChange(control, $event)"
                  />
                }
                @case ('Combo box') {
                  <app-combo-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="onInlineComboChange(control, $event)"
                  />
                }
                @case ('Text') {
                  <app-text-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="onInlineTextChange(control, $event)"
                  />
                }
                @case ('Status') {
                  <app-status-control
                    [control]="control"
                    [mode]="'inline'"
                  />
                }
                @case ('State Trigger') {
                  <app-state-trigger-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="onInlineValueChange(control, $event)"
                  />
                }
                @case ('Time') {
                  <app-time-control
                    [control]="control"
                    [mode]="'inline'"
                    (valueChange)="onInlineTimeChange(control, $event)"
                  />
                }
                @case ('Trigger') {
                  <app-trigger-control
                    [control]="control"
                    (trigger)="onInlineTrigger(control)"
                  />
                }
              }
            </div>
          </div>
        }
      </div>
    </div>
  }

  <!-- Control Editor View -->
  @if (currentView === 'editor') {
    <div class="view">
      <div class="view-header">
        <button class="back-button" (click)="backToControls()">‚Üê Back</button>
        <div class="header-text">
          <div class="component-name-header">{{ browserService.selectedComponent()?.name }}</div>
          <h2>{{ browserService.selectedControl()?.name }}</h2>
        </div>
      </div>

      @if (browserService.selectedControl(); as control) {
        <div class="control-editor">
          @if (!isCodeControl()) {
            <div class="editor-section">
              <label>Type</label>
              <div class="info-value">{{ control.type }}</div>
            </div>
          }

          <!-- Boolean Control -->
          @if (control.type === 'Boolean') {
            <div class="editor-section">
              <label>Value</label>
              <div class="toggle-group">
                <button
                  class="toggle-button"
                  [class.active]="!editValue"
                  (click)="setBooleanValue(false)"
                  [disabled]="control.direction === 'Read Only'"
                >
                  Off (0)
                </button>
                <button
                  class="toggle-button"
                  [class.active]="editValue"
                  (click)="setBooleanValue(true)"
                  [disabled]="control.direction === 'Read Only'"
                >
                  On (1)
                </button>
              </div>
            </div>
          }

          <!-- Knob/Level Control -->
          @if (control.type === 'Knob') {
            <div class="editor-section">
              @if (control.direction === 'Read Only') {
                <label>Value</label>
                <div class="info-value">{{ getDisplayValue() }}</div>
              } @else {
                <label>Level ({{ getDisplayValue() }})</label>
                <input
                  type="range"
                  class="slider"
                  [(ngModel)]="editValue"
                  (input)="onSliderInput($event)"
                  (mousedown)="onSliderDragStart()"
                  (mouseup)="onSliderDragEnd()"
                  (touchstart)="onSliderDragStart()"
                  (touchend)="onSliderDragEnd()"
                  [min]="0"
                  [max]="1"
                  step="0.01"
                />
              }
            </div>

            @if (control.direction !== 'Read Only') {
              <div class="editor-section">
                <label>Absolute Value ({{ control.valueMin ?? 0 }} - {{ control.valueMax ?? 1 }})</label>
                <input
                  type="number"
                  class="value-input"
                  [value]="getKnobAbsoluteValue()"
                  (change)="onKnobAbsoluteValueChange($event)"
                  [min]="control.valueMin ?? 0"
                  [max]="control.valueMax ?? 1"
                  [step]="getKnobValueStep()"
                />
              </div>
            }
          }

          <!-- Numeric Control (Float/Integer) -->
          @if (control.type === 'Float' || control.type === 'Integer') {
            <div class="editor-section">
              <label>Value</label>
              @if (control.direction === 'Read Only') {
                <div class="info-value">{{ editValue }}</div>
              } @else {
                <input
                  type="number"
                  class="value-input"
                  [(ngModel)]="editValue"
                  (ngModelChange)="updateControl()"
                  [step]="control.type === 'Integer' ? 1 : 0.1"
                />
              }
            </div>
          }

          <!-- Combo box Control -->
          @if (control.type === 'Combo box' && control.choices) {
            <div class="editor-section">
              <label>Value</label>
              @if (control.direction === 'Read Only') {
                <div class="info-value">{{ editValue }}</div>
              } @else {
                <select
                  class="value-input"
                  [(ngModel)]="editValue"
                  (ngModelChange)="updateControl()"
                >
                  @for (choice of control.choices; track choice) {
                    <option [value]="choice">{{ choice }}</option>
                  }
                </select>
              }
            </div>
          }

          <!-- Text Control -->
          @if (control.type === 'Text') {
            <div class="editor-section">
              <label>Value</label>
              @if (control.direction === 'Read Only' || control.direction === 'Write Only') {
                <div class="text-display">{{ editValue }}</div>
              } @else {
                <textarea
                  class="text-area-input"
                  [(ngModel)]="editValue"
                  (ngModelChange)="updateControl()"
                  rows="4"
                ></textarea>
              }
            </div>

            <!-- Lua Script Management (only for 'code' controls) -->
            @if (isCodeControl() && control.direction !== 'Read Only') {
              <div class="editor-section">
                <label>Lua Script Management</label>
                <div class="lua-script-manager">
                  @for (script of getAvailableLuaScripts(); track script.fileName) {
                    <div class="lua-script-item">
                      <div class="lua-script-info">
                        <span class="lua-script-name">{{ script.name }}</span>
                        <span class="lua-script-filename">{{ script.fileName }}</span>
                        @if (isScriptPresent(script.name)) {
                          <span class="lua-script-status present">‚úì Present</span>
                        } @else {
                          <span class="lua-script-status absent">Not present</span>
                        }
                      </div>
                      <div class="lua-script-actions">
                        @if (isScriptPresent(script.name)) {
                          <button class="lua-action-button update" (click)="insertLuaScript(script)">
                            Update
                          </button>
                          <button class="lua-action-button remove" (click)="removeLuaScript(script.name)">
                            Remove
                          </button>
                        } @else {
                          <button class="lua-action-button insert" (click)="insertLuaScript(script)">
                            Insert
                          </button>
                        }
                      </div>
                    </div>
                  }
                </div>
              </div>

              <!-- Log History Viewer -->
              <div class="editor-section">
                <div class="log-history-header">
                  <label>Log History</label>

                  <div class="script-controls-inline">
                    <!-- script.status control -->
                    <div class="script-control-inline">
                      <span class="script-control-label-inline">Status:</span>
                      <span class="script-control-value-inline status" [ngClass]="getScriptStatusClass()">
                        {{ getScriptControlValue('script.status') || 'N/A' }}
                      </span>
                    </div>

                    <!-- script.memory control -->
                    <div class="script-control-inline">
                      <span class="script-control-label-inline">Memory:</span>
                      <span class="script-control-value-inline">
                        {{ getScriptControlValue('script.memory') || 'N/A' }}
                      </span>
                    </div>

                    <!-- log.clear control -->
                    <button class="script-control-button-inline" (click)="triggerScriptControl('log.clear')">
                      Clear Log
                    </button>

                    <!-- Import discovered components button -->
                    <button class="script-control-button-inline import" (click)="parseDiscoveryResults()" [disabled]="getLogHistory().length === 0">
                      Import Components
                    </button>
                  </div>

                  <button class="clear-log-button" (click)="clearLogHistory()" [disabled]="getLogHistory().length === 0">
                    Clear
                  </button>
                </div>
                <div class="log-history-viewer">
                  @if (getLogHistory().length === 0) {
                    <div class="log-empty">No log entries yet. Logs from 'log.history' control will appear here.</div>
                  } @else {
                    <div class="log-entries">
                      @for (entry of getLogHistory(); track $index) {
                        <div class="log-entry">{{ entry }}</div>
                      }
                    </div>
                  }
                </div>
              </div>
            }
          }

          <!-- Trigger Control -->
          @if (control.type === 'Trigger') {
            <div class="editor-section">
              <label>Trigger Action</label>
              <button
                class="trigger-button"
                (click)="triggerControl()"
                [disabled]="control.direction === 'Read Only'"
              >
                Trigger
              </button>
            </div>
          }

          <!-- State Trigger Control -->
          @if (control.type === 'State Trigger') {
            @if (control.direction === 'Read Only') {
              <div class="editor-section">
                <label>Value</label>
                <div class="info-value">{{ editValue }}</div>
              </div>
            } @else {
              <div class="editor-section">
                <label>State Value</label>
                <select
                  class="value-input"
                  [(ngModel)]="editValue"
                  (ngModelChange)="updateControl()"
                >
                  @for (value of getStateTriggerValues(); track value) {
                    <option [value]="value">{{ value }}</option>
                  }
                </select>
              </div>
              <div class="editor-section">
                <label>Trigger Action</label>
                <button
                  class="trigger-button"
                  (click)="triggerControl()"
                >
                  Trigger
                </button>
              </div>
            }
          }

          <!-- Status Control -->
          @if (control.type === 'Status') {
            <div class="editor-section">
              <label>Status</label>
              @if (control.direction === 'Read Only') {
                <div class="status-display" [ngClass]="getStatusColorClass()">
                  <div class="status-value">{{ control.string || control.value || 'N/A' }}</div>
                  @if (control.value !== undefined && control.valueMin !== undefined && control.valueMax !== undefined) {
                    <div class="status-range">
                      Range: {{ control.valueMin }} - {{ control.valueMax }}
                    </div>
                  }
                </div>
              } @else {
                <select
                  class="status-select"
                  [(ngModel)]="editValue"
                  (ngModelChange)="updateControl()"
                  [ngClass]="getStatusColorClass()"
                >
                  <option [value]="0">0 - OK</option>
                  <option [value]="1">1 - Compromised</option>
                  <option [value]="2">2 - Fault</option>
                  <option [value]="3">3 - Not Present</option>
                  <option [value]="4">4 - Missing</option>
                  <option [value]="5">5 - Initializing</option>
                </select>
                @if (control.string) {
                  <div class="status-info">{{ control.string }}</div>
                }
              }
            </div>
          }

          <!-- Time Control -->
          @if (control.type === 'Time') {
            <div class="editor-section">
              <label>Time Value</label>
              @if (control.direction === 'Read Only') {
                <div class="time-display">
                  <div class="time-value">{{ control.string || control.value || 'N/A' }}</div>
                  @if (control.value !== undefined) {
                    <div class="time-info">Raw Value: {{ control.value }}</div>
                  }
                </div>
              } @else {
                <div class="time-input-group">
                  <input
                    type="text"
                    class="time-segment"
                    [(ngModel)]="timeHours"
                    (ngModelChange)="onTimeChange()"
                    (focus)="onTimeSegmentFocus($event)"
                    placeholder="00"
                    maxlength="2"
                    pattern="[0-9]{0,2}"
                  />
                  <span class="time-separator">:</span>
                  <input
                    type="text"
                    class="time-segment"
                    [(ngModel)]="timeMinutes"
                    (ngModelChange)="onTimeChange()"
                    (focus)="onTimeSegmentFocus($event)"
                    placeholder="00"
                    maxlength="2"
                    pattern="[0-9]{0,2}"
                  />
                  <span class="time-separator">:</span>
                  <input
                    type="text"
                    class="time-segment"
                    [(ngModel)]="timeSeconds"
                    (ngModelChange)="onTimeChange()"
                    (focus)="onTimeSegmentFocus($event)"
                    placeholder="00"
                    maxlength="2"
                    pattern="[0-9]{0,2}"
                  />
                </div>
              }
            </div>
          }

          @if (control.direction === 'Read Only') {
            <div class="editor-section">
              <div class="read-only-notice">This control is read-only</div>
            </div>
          }
        </div>
      }
    </div>
  }
</div>
